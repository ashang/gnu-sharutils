#! /bin/bash

## bootstrap file for sharutils
##
## Copyright (C) 1995-2013 Free Software Foundation, Inc.
##
## This program is free software; you can redistribute it and/or modify
## it under the terms of the GNU General Public License as published by
## the Free Software Foundation; either version 3, or (at your option)
## any later version.
##
## This program is distributed in the hope that it will be useful,
## but WITHOUT ANY WARRANTY; without even the implied warranty of
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
## GNU General Public License for more details.
##
## You should have received a copy of the GNU General Public License along
## with this program; if not, write to the Free Software Foundation, Inc.,
## 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.

## $Id: bootstrap,v 1.62 2011/04/26 19:36:37 bkorb Exp $

# This script is used to insert the current version number into the various
# files that need the current version number, and it inserts the current
# gettext version number into the AM_GNU_GETTEXT_VERSION macro
#
# This script is _NOT_ distributed with the product.  The _only_
# use for this script is to prep a CVS checkout of the sources for
# the initial build.  Once it has been run, it should not be necessary
# to run it again.

declare -r prog=$(basename $0 .sh)
declare -r progpid=$$
declare -r progdir=$(cd $(dirname $0) >/dev/null && pwd -P)
declare -r program=$progdir/$(basename $0)

unset CDPATH

die() {
    echo "${prog} failure: $*"
    kill -TERM ${progpid}
    sleep 1
    kill -9 $progpid
    exit 1
} >&2

init() {
    case $(set -o) in
    (*posix*) set -o posix ;;
    esac

    trap 'die early death' 0
    set -e
    cd $progdir
    test -d .git && {
        git clean -f -x -d .
    } >/dev/null 2>&1

    test -d m4 && rm -rf m4
    mkdir m4
    ln tests/sharutils.m4 m4/.

    sharutils_version=$(autoconf -t 'AC_INIT:$2' configure.ac.git)
    sharutils_eaddr=$(  autoconf -t 'AC_INIT:$3' configure.ac.git)

    autoconf_version=$(
        autoconf --version | \
            sed -e 's/autoconf.*) *//' -e '1q' )

    gettext_version=$(
        gettext --version | \
            sed -e 's/^gettext .*) *//' -e '1q' )

    automake_version=$(
        automake --version | \
            sed -e 's/^automake .*) *//' \
                -e 's/\([0-9]*\.[0-9]*\)\..*/\1/' -e 1q
    )

    nl=$'\n'
    case "$VERBOSE" in
    [tT1-9yY]* ) set -x ;;
    * ) set +x ;;
    esac

    cd ${progdir%-bld}
    rsync -Lrtvz  translationproject.org::tp/latest/sharutils/ po || \
        die "rsync failed"

    cd ${progdir}
    test "/$progdir" = "/${progdir%-bld}" || {
        for f in ${progdir%-bld}/po/*.po
        do
            g=po/$(basename $f)
            rm -f $g
            ln $f $g || ln -s $f $g
        done 2>/dev/null
    }
}

versioned_files() {
    cd src
    autogen scripts.def
    cd ..

    liboptsdir=libopts
    f=$(autoopts-config libsrc)
    case "$f" in
    *.tar.gz ) tar -xzf $f ;;
    *.tar.xz ) tar -xJf $f ;;
    *.tar.bz2) tar -xjf $f ;;
    * ) die "cannot find autoopts library source:  $f" ;;
    esac
    f=$(basename ${f%.tar.*})
    mv $f ${liboptsdir}
    cd ${liboptsdir}
    sed '/if INSTALL_LIBOPTS/,/else/d
	/^endif$/d
	/^libopts_la_LDFLAGS/d
	s/LTLIB/LIB/g
	/CPPFLAGS/s@=.*@= -I$(srcdir)@
	s/\.la/.a/
	s/libopts_la/libopts_a/g' Makefile.am > X
    mv -f X Makefile.am
    sed "/^#line/s@\.\./@${liboptsdir}/@" autoopts/usage-txt.h > X
    mv -f X autoopts/usage-txt.h
    cd ..
    sed '/end .* of INVOKE_LIBOPTS_MACROS/q' \
        ${liboptsdir}/m4/libopts.m4 > m4/libopts.m4

    test -d intl || mkdir intl || die "cannot make intl directory"
    month_stamp=$(date '+%B %Y')
    date_stamp=$(date +'%d %B %Y')
    vline="Version ${sharutils_version} - "${month_stamp}
    sed "1,5s/^Version .* by /${vline}, by /" NEWS.git > NEWS

    tag='Language file updates:'
    sed "/^${tag}/,\$d" README.git > README
    exec 3>> README
    echo "${tag}" >&3

    # Isolate all the .po files so that they are not auto-updated
    # every time the autotools are run.
    #
    cd po
    for f in *.po
    do
        cp -fp $f $f-xx
        mv -f $f-xx $f
    done
    fgrep PO-Revision-Date: *.po | \
        sed 's/\.po: *"PO-Revision-Date: */\t/;s/ [0-2][0-9]:.*//' | \
        sort -t$'\t' -k +2 -r >&3
    exec 3>&-
    cd ..

    {
        cat <<-  _EOVers_
		m4_define([gettext_version], [${gettext_version}])
		AC_PREREQ([${autoconf_version}])
		_EOVers_

        case "${sharutils_version}" in
        *.*pre* ) echo '[DIST_ALPHA=README-alpha]' ;;
        *)      echo '[DIST_ALPHA=]' ;;
        esac
    } > version.m4

    cat > doc/version.texi <<- _EOVersion_
	@c Do not edit thie file
	@c This is generated by the ${prog} script

	@set UPDATED ${date_stamp}
	@set UPDATED-MONTH ${month_stamp}
	@set EDITION ${sharutils_version}
	@set VERSION ${sharutils_version}
	_EOVersion_
}

setup_configure() {
    #  Make sure the gettext version is up to date.  You cannot use the
    #  normal m4_define from version.m4 'cuz the gettext macros are
    #  specially designed to not allow that.  So, we use sed.
    #  While we're messing with it, update the automake version, too.
    #
    sed -e "/^AM_INIT_AUTOMAKE/s/(\[[0-9.]*/([${automake_version}/" \
        -e "/^AM_GNU_GETTEXT_VERSION/s/(\[[0-9.]*/([${gettext_version}/" \
        configure.ac.git > configure.ac

    exec 3> po/LINGUAS
    echo '# Set of available languages:' >&3
    ls -1 po | sed -n 's/\.po$//p' | columns --spread=1 >&3
    exec 3>&-

    find . -type f | xargs chmod ugo-x
    chmod -R go-w .
    chmod a+x tests/*-[1-9] bootstrap

    shar_lib_hdrs=$(ls -1 lib | egrep -v '^(CVS|SCCS)$')
    extra_dist=$'\n## begin sharutils extras\n\nEXTRA_DIST += \\\n'$(
        echo "${shar_lib_hdrs}" | columns -I4 --spread=1 --line=' \')

    if test -x ../gnulib/gnulib-tool
    then glib=$(cd ../gnulib >/dev/null; pwd)/gnulib-tool
    else
      glib=$(which gnulib-tool)
    fi
    test -x "${glib}" || die "cannot locate gnulib-tool"

    gnulib_libs="
	alloca
	dirname
	error
	fdl
	getcwd
	getopt-gnu
	gettext
	inttostr
	malloc-gnu
	crypto/md5
	mktime
	pathmax
	popen
	quotearg
	realloc-gnu
	stpcpy
	string
	stdlib
	strerror
	strftime
	uname
	unlocked-io
	xalloc
	xgetcwd
	xstrtoimax
"

    echo autopoint --force >&2
    autopoint --force > /dev/null 2>&1
    echo  ${glib} --import  ... >&2
    {
      ${glib} --import ${gnulib_libs} 2>&1
    } | sed '1,/^You may need to add #include/d' | \
      tee import-log.txt
    echo "${extra_dist}" >> lib/Makefile.am
    test -f fdl.texi && mv fdl.texi doc/.
    AUTOPOINT=true autoreconf --force --install -Wall || true

    chmod ugo-x COPYING INSTALL doc/texinfo.tex
    rm -f m4/*~
}

update_include_list() {
  cd src

  # Collect all the #include directives and unique-ify them
  #
  ilist=$(
    {
      sed -n 's/^ *#include/#include/p' ../import-log.txt
      echo '#include "error.h"'
      echo '#include "locale.h"'
      echo '#include "system.h"'
    } | sort -u)

  # separate them by quoting type:  <> vs. ""
  # and append a backslash to all but the last line.
  # sed(1) requires this for inserting text.
  #
  ilist=$(
    {
      echo "$ilist" | fgrep '<'
      echo ''
      echo "$ilist" | fgrep '"'
    } | sed 's/$/\\/;$s/\\$//')

  # now insert this list into "local.h".
  #
  sed "s@^INCLUDE-LIST\$@${ilist}@" local.h.git > local.h
  cd ..
  rm -f import-log.txt
}

generate_option_code() {
    cd src
    for def in *-opts.def
    do
        autogen $def
        autogen -b ${def%-opts.def} -Tagman-cmd.tpl $def
        mv -f ${def%-opts.def}.1 ../doc
        autogen -Tagtexi-cmd.tpl -DSECTION=chapter $def
        mv -f invoke-${def%-opts.def}.texi ../doc/.
        rm -f invoke-${def%-opts.def}.menu
    done
    cd ..
    {
        echo '# List of files which containing translatable strings.'
        grep '[C]opyright [(]C[)]' $script
        printf '\n# Package source files\n'
        ls -1 src/*.[chx]
        printf '\n# Compatibility library source files\n'
        ls -1 lib/*.[ch]
        printf "\n# AutoOpts source file\n${liboptsdir}/autoopts/usage-txt.h\n"
    } > po/POTFILES.in
}

PS4='>${FUNCNAME:-bs}> '
script=$0
init
versioned_files
setup_configure
update_include_list
generate_option_code
trap '' 0
(exit 0) ; exit

#  Local Variables:
#  mode: shell-script
#  tab-width: 8
#  indent-tabs-mode: nil
#  sh-indentation: 4
#  sh-basic-offset: 4
#  End:
# 
#  end of bootstrap
